-- ================================================
-- Migration: 007_migrate_i18n_data_with_audit
-- Description: Migrate existing Hebrew content to i18n columns
--              with audit_log trigger compatibility
-- Date: 2025-10-02
-- ================================================

-- Wrap everything in a transaction and set session variables
BEGIN;

-- Set session variables for audit_log trigger
SELECT set_config('app.current_user', 'system_migration', false);
SELECT set_config('app.current_role', 'admin', false);

-- ==================== EVENTS MIGRATION ====================

UPDATE events
SET
  title_i18n = jsonb_build_object('he', '×™×©×™×‘×ª ×•×¢×“ ×—×•×“×©×™×ª - ×“×¦×ž×‘×¨ 2024'),
  description_i18n = jsonb_build_object('he', '×™×©×™×‘×ª ×•×¢×“ ×”×•×¨×™× ×—×•×“×©×™×ª ×œ×—×•×“×© ×“×¦×ž×‘×¨.

× ×•×©××™× ×œ×“×™×•×Ÿ:
- ×¡×™×›×•× ×¤×¢×™×œ×•×ª × ×•×‘×ž×‘×¨
- ×ª×›× ×•×Ÿ ××™×¨×•×¢×™ ×—× ×•×›×”
- ××™×©×•×¨ ×ª×§×¦×™×‘ ×œ×¤×¢×™×œ×•×ª ×—×•×¨×£
- ×¢×“×›×•×Ÿ ×¢×œ ×¤×¨×•×™×§×˜ ×—×™×“×•×© ×—×¦×¨ ×‘×™×ª ×”×¡×¤×¨
- ×”×¦×¢×•×ª ×œ×”×¨×¦××•×ª ×”×•×¨×™×

×›×•×œ× ×ž×•×–×ž× ×™× ×œ×”×©×ª×ª×£ ×•×œ×”×©×ž×™×¢ ××ª ×“×¢×ª×!'),
  location_i18n = jsonb_build_object('he', '×—×“×¨ ×”×ž×•×¨×™×, ×‘×™×ª ×¡×¤×¨ ×™×¡×•×“×™')
WHERE id = 'c8478ab0-9e89-46e8-9238-b778aeb2b638';

UPDATE events
SET
  title_i18n = jsonb_build_object('he', '×ž×¡×™×‘×ª ×—× ×•×›×” ×œ×›×œ ×”×ž×©×¤×—×”'),
  description_i18n = jsonb_build_object('he', '×—×’×™×’×ª ×—× ×•×›×” ×ž×™×•×—×“×ª ×œ×›×œ ×ª×œ×ž×™×“×™ ×‘×™×ª ×”×¡×¤×¨ ×•×”×•×¨×™×”×!

×‘×ª×›× ×™×ª:
ðŸ•¯ï¸ ×”×“×œ×§×ª × ×¨×•×ª ×ž×©×•×ª×¤×ª
ðŸ© ×“×•×›× ×™ ×¡×•×¤×’× ×™×•×ª ×•×œ×‘×™×‘×•×ª
ðŸŽ­ ×”×¦×’×ª ×—× ×•×›×” ×©×œ ×›×™×ª×•×ª ×“×³
ðŸŽµ ×©×™×¨×” ×‘×¦×™×‘×•×¨
ðŸŽ ×©×•×§ ×—× ×•×›×” - ×™×¨×™×“ ×™×¦×™×¨×•×ª ×ª×œ×ž×™×“×™×

×”×›× ×™×¡×” ×—×•×¤×©×™×ª!
×™×© ×œ×”×‘×™× ×¦×œ×—×•×ª ×•×›×œ×™× ×¨×‘ ×¤×¢×ž×™×™×.'),
  location_i18n = jsonb_build_object('he', '××•×œ× ×”×¡×¤×•×¨×˜ ×©×œ ×‘×™×ª ×”×¡×¤×¨')
WHERE id = '9d50cf39-4f30-4285-84ed-092832994b9b';

UPDATE events
SET
  title_i18n = jsonb_build_object('he', '×”×¨×¦××ª ×”×•×¨×™×: "×’×‘×•×œ×•×ª ×‘×¢×™×“×Ÿ ×”×“×™×’×™×˜×œ×™"'),
  description_i18n = jsonb_build_object('he', '×”×¨×¦××” ×ž×¨×ª×§×ª ×œ×”×•×¨×™× ×‘× ×•×©× ×”×¦×‘×ª ×’×‘×•×œ×•×ª ×œ×™×œ×“×™× ×‘×¢×•×œ× ×”×“×™×’×™×˜×œ×™.

×”×ž×¨×¦×”: ×“"×¨ ×™×¢×œ ×›×”×Ÿ, ×¤×¡×™×›×•×œ×•×’×™×ª ×§×œ×™× ×™×ª ×•×ž×•×ž×—×™×ª ×œ×”×ª×ž×›×¨×•×™×•×ª ×“×™×’×™×˜×œ×™×•×ª

× ×•×©××™ ×”×”×¨×¦××”:
â€¢ ×–×ž×Ÿ ×ž×¡×š ×ž×•×ž×œ×¥ ×œ×¤×™ ×’×™×œ××™×
â€¢ ×¡×™×ž× ×™ ××–×”×¨×” ×œ×”×ª×ž×›×¨×•×ª
â€¢ ×›×œ×™× ×ž×¢×©×™×™× ×œ×”×¦×‘×ª ×’×‘×•×œ×•×ª
â€¢ ×™×¦×™×¨×ª ×”×¡×›× ×ž×©×¤×—×ª×™ ×œ×©×™×ž×•×© ×‘×ž×¡×›×™×
â€¢ ×ž×¢× ×” ×œ×©××œ×•×ª ×”×•×¨×™×

×”×”×¨×¦××” ×ž×™×•×¢×“×ª ×œ×”×•×¨×™ ×ª×œ×ž×™×“×™× ×‘×›×œ ×”×’×™×œ××™×.
×›×™×‘×•×“ ×§×œ ×™×•×’×© ×‘×”×¤×¡×§×”.'),
  location_i18n = jsonb_build_object('he', '××•×œ× ×”×›× ×¡×™×, ×§×•×ž×” 2')
WHERE id = '7b1e6436-d1f9-42cb-bbbf-915c3b7457b7';

UPDATE events
SET
  title_i18n = jsonb_build_object('he', '×˜×™×•×œ ×ž×©×¤×—×•×ª ×œ×™×¨×•×©×œ×™×'),
  description_i18n = jsonb_build_object('he', '×˜×™×•×œ ×ž×©×¤×—×•×ª ×ž××•×¨×’×Ÿ ×œ×™×¨×•×©×œ×™×!

×ž×¡×œ×•×œ ×”×˜×™×•×œ:
ðŸšŒ 07:00 - ×™×¦×™××” ×ž×‘×™×ª ×”×¡×¤×¨
ðŸ›ï¸ 09:00 - ×¡×™×•×¨ ×ž×•×“×¨×š ×‘×ž×•×–×™××•×Ÿ ×™×©×¨××œ
ðŸ” 12:00 - ××¨×•×—×ª ×¦×”×¨×™×™× (×¢×¦×ž××™×ª)
ðŸŽ¨ 14:00 - ×¡×“× ×ª ×™×¦×™×¨×” ×œ×™×œ×“×™× ×‘×ž×•×–×™××•×Ÿ
ðŸ›ï¸ 16:00 - ×–×ž×Ÿ ×—×•×¤×©×™ ×‘×©×•×§ ×ž×—× ×” ×™×”×•×“×”
ðŸšŒ 18:00 - ×—×–×¨×” ×”×‘×™×ª×”

×”×ž×—×™×¨ ×›×•×œ×œ: ×”×¡×¢×”, ×›× ×™×¡×” ×œ×ž×•×–×™××•×Ÿ ×•×¡×“× ×”.
×”×ž×—×™×¨ ××™× ×• ×›×•×œ×œ: ××¨×•×—×ª ×¦×”×¨×™×™×.

×ž×¡×¤×¨ ×”×ž×§×•×ž×•×ª ×ž×•×’×‘×œ!'),
  location_i18n = jsonb_build_object('he', '× ×§×•×“×ª ××™×¡×•×£: ×—× ×™×™×ª ×‘×™×ª ×”×¡×¤×¨')
WHERE id = 'adeeaaae-b855-4e14-b699-9ea78797a154';

UPDATE events
SET
  title_i18n = jsonb_build_object('he', '×™×•× ×¡×¤×•×¨×˜ ×‘×™×ª ×¡×¤×¨×™'),
  description_i18n = jsonb_build_object('he', '×™×•× ×¡×¤×•×¨×˜ ×•×›×™×£ ×œ×›×œ ×ª×œ×ž×™×“×™ ×‘×™×ª ×”×¡×¤×¨!

×œ×•"×– ×”×™×•×:
08:30 - ×”×ª×›× ×¡×•×ª ×•×—×œ×•×§×” ×œ×‘×ª×™×
09:00 - ×˜×§×¡ ×¤×ª×™×—×”
09:30 - ×ª×—×¨×•×™×•×ª ×¡×¤×•×¨×˜ ×œ×¤×™ ×©×›×‘×•×ª
11:00 - ×”×¤×¡×§×ª ×¤×™×¨×•×ª
11:30 - ×ž×©×—×§×™ ×‘×ª×™×
13:00 - ×˜×§×¡ ×¡×™×•× ×•×—×œ×•×§×ª ×’×‘×™×¢×™×

×ª×œ×ž×™×“×™× × ×“×¨×©×™× ×œ×”×’×™×¢ ×¢×:
- ×‘×’×“×™ ×¡×¤×•×¨×˜ ×•× ×¢×œ×™ ×¡×¤×•×¨×˜
- ×›×•×‘×¢
- ×‘×§×‘×•×§ ×ž×™×
- ××¨×•×—×ª ×‘×•×§×¨

×•×¢×“ ×”×”×•×¨×™× ×™×“××’ ×œ×¤×™×¨×•×ª ×•×©×ª×™×™×” ×§×¨×” ×‘×ž×”×œ×š ×”×™×•×.'),
  location_i18n = jsonb_build_object('he', '×ž×’×¨×© ×”×¡×¤×•×¨×˜ ×©×œ ×‘×™×ª ×”×¡×¤×¨')
WHERE id = '8906aa16-a0f2-4ca7-9e32-2d3a00df5916';

UPDATE events
SET
  title_i18n = jsonb_build_object('he', '×¢×¨×‘ ×’×™×•×¡ ×›×¡×¤×™× - ×ž×›×™×¨×ª ×¢×•×’×•×ª'),
  description_i18n = jsonb_build_object('he', '×¢×¨×‘ ×’×™×•×¡ ×›×¡×¤×™× ×œ×ž×¢×Ÿ ×©×™×¤×•×¥ ×¡×¤×¨×™×™×ª ×‘×™×ª ×”×¡×¤×¨.

×ž×” ×‘×ª×›× ×™×ª:
ðŸ° ×ž×›×™×¨×ª ×¢×•×’×•×ª ×‘×™×ª - ×ª×¨×•×ž×ª ×”×”×•×¨×™×
â˜• ×‘×™×ª ×§×¤×” ×–×ž× ×™
ðŸŽ¶ ×ž×•×–×™×§×” ×—×™×” - ×ª×œ×ž×™×“×™ ×”×ž×’×ž×” ×”×ž×•×–×™×§×œ×™×ª
ðŸŽ¯ ×“×•×›× ×™ ×ž×©×—×§×™× ×œ×™×œ×“×™×
ðŸŽ ×”×’×¨×œ×” - ×¤×¨×¡ ×¨××©×•×Ÿ: ×¡×•×¤"×© ×‘×¦×™×ž×¨!

×›×œ ×”×”×›× ×¡×•×ª ×§×•×“×© ×œ×©×™×¤×•×¥ ×”×¡×¤×¨×™×™×”!

×”×•×¨×™× ×”×ž×¢×•× ×™×™× ×™× ×œ×ª×¨×•× ×¢×•×’×•×ª ×ž×ª×‘×§×©×™× ×œ×”×™×¨×©× ×ž×¨××©.'),
  location_i18n = jsonb_build_object('he', '×—×¦×¨ ×‘×™×ª ×”×¡×¤×¨')
WHERE id = 'fa646906-06af-4879-88ad-7a09e092f786';

-- ==================== TASKS MIGRATION ====================

UPDATE tasks
SET
  title_i18n = jsonb_build_object('he', '×”×–×ž× ×ª ×›×™×‘×•×“ ×œ×™×©×™×‘×ª ×”×•×¢×“'),
  description_i18n = jsonb_build_object('he', '×œ×”×–×ž×™×Ÿ ×›×™×‘×•×“ ×§×œ ×œ×™×©×™×‘×ª ×”×•×¢×“ ×”×—×•×“×©×™×ª - ×¢×•×’×™×•×ª, ×¤×™×¨×•×ª, ×©×ª×™×™×” ×—×ž×” ×•×§×¨×”')
WHERE id = 'dc70dce2-549f-495a-95ca-9392778a8925';

UPDATE tasks
SET
  title_i18n = jsonb_build_object('he', '×ª×™××•× ×”×¡×¢×•×ª ×œ×˜×™×•×œ ×œ×™×¨×•×©×œ×™×'),
  description_i18n = jsonb_build_object('he', '×œ×™×¦×•×¨ ×§×©×¨ ×¢× ×—×‘×¨×ª ×”×”×¡×¢×•×ª, ×œ×§×‘×œ ×”×¦×¢×•×ª ×ž×—×™×¨ ×•×œ×¡×’×•×¨ ×”×–×ž× ×” ×œ-2 ××•×˜×•×‘×•×¡×™×')
WHERE id = 'a740c76d-7b4d-453a-a31e-a817b2fb9c80';

UPDATE tasks
SET
  title_i18n = jsonb_build_object('he', '×”×›× ×ª ×ž×¦×’×ª ×œ×™×©×™×‘×ª ×”×”×•×¨×™×'),
  description_i18n = jsonb_build_object('he', '×œ×”×›×™×Ÿ ×ž×¦×’×ª ×¢× ×¡×™×›×•× ×¤×¢×™×œ×•×ª ×”×•×¢×“ ×œ×¨×‘×¢×•×Ÿ ×”××—×¨×•×Ÿ')
WHERE id = '5b668f7a-db78-4208-a13b-d077fa06e076';

UPDATE tasks
SET
  title_i18n = jsonb_build_object('he', '×¤×¨×¡×•× ××™×¨×•×¢ ×—× ×•×›×” ×‘×¨×©×ª×•×ª ×”×—×‘×¨×ª×™×•×ª'),
  description_i18n = jsonb_build_object('he', '×œ×”×›×™×Ÿ ×¤×•×¡×˜ ×ž×¢×•×¦×‘ ×•×œ×¤×¨×¡× ×‘×§×‘×•×¦×•×ª ×”×•×•×˜×¡××¤ ×•×‘×¤×™×™×¡×‘×•×§ ×©×œ ×”×”×•×¨×™×')
WHERE id = '2995f11b-c836-4eba-8b47-222c7cf80f9a';

UPDATE tasks
SET
  title_i18n = jsonb_build_object('he', '×¨×›×™×©×ª ×¤×¨×¡×™× ×œ×”×’×¨×œ×”'),
  description_i18n = jsonb_build_object('he', '×œ×¨×›×•×© ×¤×¨×¡×™× ×œ×”×’×¨×œ×” ×‘×¢×¨×‘ ×’×™×•×¡ ×”×›×¡×¤×™× - ×ª×§×¦×™×‘ 2000 ×©"×—')
WHERE id = '7e63a138-aaa0-44eb-84a0-1602a1e7011a';

-- ==================== VERIFICATION ====================
-- Check migration results

SELECT
  'events' as table_name,
  COUNT(*) as total,
  COUNT(CASE WHEN title_i18n->>'he' IS NOT NULL THEN 1 END) as migrated
FROM events;

SELECT
  'tasks' as table_name,
  COUNT(*) as total,
  COUNT(CASE WHEN title_i18n->>'he' IS NOT NULL THEN 1 END) as migrated
FROM tasks;

-- Show sample migrated data
SELECT id, title, title_i18n->>'he' as title_he FROM events LIMIT 3;
SELECT id, title, title_i18n->>'he' as title_he FROM tasks LIMIT 3;

-- Commit the transaction
COMMIT;
